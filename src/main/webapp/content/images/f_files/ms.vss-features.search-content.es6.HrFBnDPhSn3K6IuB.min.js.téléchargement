"use strict";define("VSS/Features/Search",["require","exports","VSS/Platform/Context","react","VSS/Core/Observable","VSS/Platform/Feature","VSS/Platform/Layout","VSSUI/Icon","VSSUI/Menu","VSS/Platform/Util/DOM","VSSUI/Util","VSS/Platform/Components/Format"],function(e,t,s,r,n,i,o,a,c,h,l,p){var u,d,v,m,S;u=t.Resources={},Object.defineProperty(t,"__esModule",{value:!0}),t.Resources.AccountLabel="This organization",t.Resources.ExecuteSearch="Get search results",t.Resources.Global="Global",t.Resources.HelpNoSuggestions="No suggestions",t.Resources.ProjectLabel="This project",t.Resources.SearchChangeType="Change search type",t.Resources.SearchFindHelp="For more ways to search, see the {0}",t.Resources.SearchHelpLess="Show less",t.Resources.SearchHelpMore="Show more",t.Resources.SearchHelpPage="help page",t.Resources.SearchPageTitle="Search",t.Resources.SearchPlaceholder="Search",t.Resources.ClearText="Clear text",function(e){t.Coordinator={},Object.defineProperty(t,"__esModule",{value:!0});s.Services.add("inprocess-search-coordinator",{serviceFactory:class extends s.VssService{execute(e){const t=this.pageContext.getService("IVssContributionService");return t.getContributionAsync(e.providerId).then(s=>{if(s)return t.getService(e.providerId).then(t=>{if(t)return t.execute(e);throw new Error("Unable to create search provider service for '"+e.providerId+"'.")});throw new Error("Search provider '"+e.providerId+"' was not defined.")})}}})}(),function(e){d=t.SearchInputSearchInput={},Object.defineProperty(t,"__esModule",{value:!0});class s extends n.Observable{constructor(e,t,s,r,n,i){super(),this.appendText=e,this.queryText=t,this.replaceText=s,this.setHelpVisibility=r,this.setHelpSearchProviderId=n,this.executeSearch=i}textChanged(e){this.notify(e,"change")}keyDown(e){this.notify(e,"keyDown")}}function h(){return!!/edge\/([\d+.]+)/i.exec(navigator.userAgent)}t.SearchInputSearchInput.SearchInputComponent=class extends o.VssComponent{constructor(e,t){super(e,t),this.availableProviders={},this.onBlur_Component=(e=>{const t=e.relatedTarget||document.activeElement;this.setState({hasFocus:this.searchElement.current&&this.searchElement.current.contains(t)||this.helpElement.current&&this.helpElement.current.contains(t)||!!this.state.providerMenuItems,hideHelp:!(this.inputElement.current&&this.inputElement.current.contains(t)||this.helpElement.current&&this.helpElement.current.contains(t)||this.clearButton.current&&this.clearButton.current.contains(t))})}),this.onChange=(()=>{if(null!==this.inputElement.current){const e=this.inputElement.current.value.length>0;this.setState({hideHelp:!1,contentAvailable:e,hasFocus:!0,helpSearchProviderId:void 0,helpSearchProvider:void 0}),this.searchInput.textChanged(this.inputElement.current.value)}}),this.onFocus_Component=(()=>{this.state.hasFocus||this.setState({hasFocus:!0})}),this.onFocus_Input=(()=>{this.state.hasFocus||(this.setState({hasFocus:!0,hideHelp:!1}),this.props.onInputFocus&&this.props.onInputFocus())}),this.onProvidersDismiss=(()=>{this.setState({hasFocus:!!this.searchElement.current&&this.searchElement.current.contains(document.activeElement),hideHelp:!1,providerMenuItems:void 0})}),this.onKeyDown_Help=(e=>{if(27===e.which)this.focus(),this.state.hideHelp||(this.setState({hideHelp:!0}),e.preventDefault());else if(38===e.which){const t=e.target||document.activeElement;this._getFirstFocusElementInHelpDropdown()===t&&(this.focus(),e.stopPropagation())}}),this.onKeyDown_Input=(e=>{if(13===e.which)this.executeSearch(e.ctrlKey);else if(27===e.which)this.state.hideHelp||(this.setState({hideHelp:!0}),e.preventDefault());else if(40===e.which)if(this.sendKeysToHelp())this.searchInput.keyDown(e.key);else{const t=this._getNextToFocusedElement()||this._getFirstFocusElementInHelpDropdown();t&&t.focus(),e.stopPropagation(),e.preventDefault()}else 38===e.which&&this.sendKeysToHelp()&&(this.searchInput.keyDown(e.key),e.preventDefault())}),this.sendKeysToHelp=(()=>!0===this.props.sendKeysToHelp),this.onKeyDown_Provider=(e=>{13!==e.which&&32!==e.which&&40!==e.which||this.showProviderMenu()}),this.onKeyDown_Search=(e=>{13!==e.which&&32!==e.which||this.executeSearch(e.ctrlKey)}),this.onProviderChanged=(e=>{this.setState({customProviderSelected:!0,selectedProviderId:e})}),this.onSearchClicked=(e=>{this.executeSearch(e.ctrlKey)}),this.showProviderMenu=(()=>{let e=[];for(let t of Object.keys(this.availableProviders))t!=this.state.selectedProviderId&&e.push({id:t,onActivate:()=>{this.setState({customProviderSelected:!0,selectedProviderId:t}),this.focus()},text:this.availableProviders[t].providerName});this.setState({hideHelp:!0,providerMenuItems:e})}),this.onKeyDown_ClearText=(e=>{13!==e.which&&32!==e.which||this.clearInput()}),this.clearInput=(()=>{this.replaceOrAppendText("",!1)}),this.replaceOrAppendText=((e,t=!0,s=!0,r)=>{if(null!==this.inputElement.current){const r=t?this.inputElement.current.value+(this.inputElement.current.value.length>0?" ":"")+e:e;this.inputElement.current.value=r,this.setState({contentAvailable:!0}),s&&this.searchInput.textChanged(this.inputElement.current.value),this.focus(!0)}}),this.state={},this.state=this.processProviders(e),this.searchElement=r.createRef(),this.inputElement=r.createRef(),this.helpElement=r.createRef(),this.clearButton=r.createRef()}render(){let e=this.props.placeholderText||this.state.selectedProviderId&&this.availableProviders[this.state.selectedProviderId]&&this.availableProviders[this.state.selectedProviderId].placeholder||u.SearchPlaceholder;const t=this.inputElement.current?this.inputElement.current.value:"";let s=null;if(!this.state.hideHelp&&this.state.hasFocus&&this.state.shownProvider&&this.state.shownProvider.help){let e=this.state.shownProvider.help(this.searchInput);if(e){const{dropdownGapSize:t}=this.props,n=i.isFeatureEnabled(this.context.pageContext,"ms.vss-tfs-web.enable-search-suggestions",!1)?151:t;s=r.createElement(o.WrappedComponent,Object.assign({dependencies:["ms.vss-features.ui-content"],wrappedType:"callout"},{anchorOffset:{horizontal:n,vertical:t},anchorElement:this.searchElement.current,anchorOrigin:{horizontal:"end",vertical:"end"},calloutOrigin:{horizontal:"end",vertical:"start"},className:"search-help-callout search-callout",contentShadow:!0,focuszoneProps:{focusOnMount:!1,disabled:!1,direction:2,circularNavigation:!0}}),r.createElement("div",{id:this.props.helpId,className:this.props.helpClassName,ref:this.helpElement,onKeyDown:this.onKeyDown_Help},e))}}return this.state.selectedProviderId?r.createElement("div",{ref:this.searchElement,className:o.css("flex-cell","search",this.state.hasFocus?" focus":""),onBlur:this.onBlur_Component,onFocus:this.onFocus_Component,"aria-label":this.props.ariaLabel,role:"search"},this.props.showSearchIcon&&r.createElement("div",{className:"search-icon cursor-pointer",onClick:this.onSearchClicked,onKeyDown:this.onKeyDown_Search,role:"button",tabIndex:this.state.contentAvailable?0:void 0,title:u.ExecuteSearch},r.createElement(a.Icon,{iconName:"Search"})),r.createElement("input",{ref:this.inputElement,className:"search-input",onChange:this.onChange,onFocus:this.onFocus_Input,onKeyDown:this.onKeyDown_Input,placeholder:e,spellCheck:this.props.spellCheck,"aria-label":this.props.inputAriaLabel||e,type:"text"}),t&&r.createElement("div",{ref:this.clearButton,className:"clear-text-icon cursor-pointer",role:"button",tabIndex:this.state.contentAvailable?0:void 0,onKeyDown:this.onKeyDown_ClearText,title:u.ClearText,onClick:this.clearInput},r.createElement(a.Icon,{iconName:"ChromeClose"})),this.props.showSearchProviders&&Object.keys(this.availableProviders).length>1?r.createElement("div",{"aria-owns":this.state.providerMenuItems&&"search-providers-menu",className:"search-icon",onClick:this.showProviderMenu,onKeyDown:this.onKeyDown_Provider,role:"button",tabIndex:0,title:u.SearchChangeType},r.createElement("span",{className:"ms-Icon ms-Icon--ChevronDown ms-SearchBox-icon"})):null,s,this.state.providerMenuItems&&this.searchElement.current?r.createElement(c.ContextualMenu,{anchorElement:this.searchElement.current,menuProps:{id:"search-providers-menu",items:this.state.providerMenuItems},onDismiss:this.onProvidersDismiss}):null):null}componentDidMount(){super.componentDidMount(),this.context.pageContext.getService("IVssSearchService").subscribe(this.onProviderChanged,"providerSelected"),this.props.initialQueryText&&this.setQueryText(this.props.initialQueryText),this.searchInput=new s((e,t)=>{this.replaceOrAppendText(e,!0,t)},()=>null!==this.inputElement.current?this.inputElement.current.value:"",(e,t)=>{this.replaceOrAppendText(e,!1,t)},e=>{this.setState({hideHelp:e})},e=>{e&&this.context.pageContext.getService("IVssContributionService").getService(e).then(t=>{t&&this.setState({helpSearchProviderId:e,helpSearchProvider:t})})},e=>{this.executeSearch(e)}),this.props.componentRef&&this.props.componentRef(this)}componentWillUnmount(){this.context.pageContext.getService("IVssSearchService").unsubscribe(this.onProviderChanged,"providerSelected"),super.componentWillUnmount()}componentWillReceiveProps(e){e.selectedProviderId&&e.selectedProviderId!==this.state.selectedProviderId&&this.setState(this.processProviders(e))}hasFocus(){return this.state.hasFocus}focus(e){const t=this.inputElement.current;if(t){t.focus();const s=t.value.length;e?this.setSelection(s,s):this.setSelection(0,s)}}blur(){this.inputElement.current&&this.inputElement.current.blur()}setQueryText(e){this.inputElement.current&&this.inputElement.current.value!==e&&(this.inputElement.current.value=e)}getQueryText(){return this.inputElement.current?this.inputElement.current.value:""}setState(e){super.setState(e,()=>{if(this.state.selectedProviderId&&this.state.selectedProviderId!=this.state.shownProviderId){const e=this.context.pageContext.getService("IVssContributionService"),t=this.state.selectedProviderId;e.getService(t).then(e=>{e&&this.setState({shownProvider:e,shownProviderId:t})})}})}setSelection(e,t){const s=this.inputElement.current;s&&(h()&&(s.selectionStart=e),setTimeout(()=>{s.selectionStart=e,s.selectionEnd=t},0))}executeSearch(e){if(null!==this.inputElement.current){const t=this.inputElement.current.value;let s=this.state.shownProviderId,r=this.state.shownProvider;if(this.state.helpSearchProvider&&this.state.helpSearchProviderId&&(r=this.state.helpSearchProvider,s=this.state.helpSearchProviderId),s&&r){let n={queryText:t,providerId:s,openInNewWindow:e};r.getQuery&&(n=r.getQuery(n)),r.performAction?r.performAction(n).then(e=>{e||this.executeSearchAndHideHelp(n)},()=>this.executeSearchAndHideHelp(n)):this.executeSearchAndHideHelp(n)}}}executeSearchAndHideHelp(e){e.queryText&&(this.props.executeSearch(e),this.setState({hideHelp:!0}))}processProviders(e){const t=this.context.pageContext.getService("IVssSearchService"),s=t.getProviders();let r,n;this.availableProviders={};for(let t in s)e.availableProviderIds&&-1==e.availableProviderIds.indexOf(t)||(this.availableProviders[t]=s[t]);if(e.selectedProviderId&&this.availableProviders[e.selectedProviderId]&&(n=e.selectedProviderId,r=!0),!r||!n){const e=t.getSelectedProvider();e&&(n=e)}return{customProviderSelected:r,selectedProviderId:n}}_getNextToFocusedElement(){return this.helpElement.current?this.helpElement.current.querySelector("tr.focused + tr[tabIndex='-1']"):null}_getFirstFocusElementInHelpDropdown(){return this.helpElement.current?this.helpElement.current.querySelector("li[tabIndex='-1']")||this.helpElement.current.querySelector("tr[tabIndex='-1']"):null}},t.SearchInputSearchInput.isIE=function(){const e=window.navigator.userAgent.toLowerCase();return!!/msie ([\d+.]+)/i.exec(navigator.userAgent)||-1!==e.indexOf("trident")},t.SearchInputSearchInput.isEdge=h}(),function(e){v=t[e]={},Object.defineProperty(t,"__esModule",{value:!0}),function(s){for(var r in s)t[e].hasOwnProperty(r)||(t[e][r]=s[r])}(d)}("SearchInput"),function(e){t.ExpandableSearchBoxExpandableSearchBox={},Object.defineProperty(t,"__esModule",{value:!0});o.VssComponent.register("expandableSearchHeader",class extends o.VssComponent{constructor(e,t){super(e),this._isSearchSuggestionsEnabled=!1,this._project=!1,this._onExecuteSearch=(e=>{this.context.pageContext.getService("IVssSearchService").execute(e)}),this._dispatchEvent=(e=>{const t=document.createEvent("Event");t.initEvent(e,!1,!0),window.dispatchEvent(t)}),this._expandSearchBox=(()=>{this._publishTelemetry(),this._dispatchEvent("searchExpanded"),this.setState({isExpanded:!0})}),this._collapseSearchBox=(e=>{this._dispatchEvent("searchCollapsed"),this.setState({isExpanded:!1,selectedProviderId:e?void 0:this.state.selectedProviderId})}),this._onBlur=(e=>{const t=e.relatedTarget||document.activeElement;this._searchHeader&&!h.contains(this._searchHeader,t)&&this._collapseSearchBox()}),this._onSearchTabLoaded=(e=>{const t=e.detail;t&&t.providerId&&this.setState({selectedProviderId:t.providerId,isExpanded:!1})}),this._publishTelemetry=(()=>{const e=this.context.pageContext.getService("IVssTelemetryService"),t=this.context.pageContext.getService("IVssNavigationService").getDisplayedNavigation(),s=t.length>=3?t[2]:"",r=t.length>=4?t[3]:"";e.publishEvent("WebPlatform","L1SearchBarFocussed",{launchPoint_HubGroup:s,launchPoint_hub:r})}),this.state={isExpanded:!1,selectedProviderId:void 0};const s=t.pageContext.getService("IVssSearchService");this._providersAvailable=Object.keys(s.getProviders()).length>0,this._isSearchSuggestionsEnabled=i.isFeatureEnabled(t.pageContext,"ms.vss-tfs-web.enable-search-suggestions",!1);const r=t.pageContext.getService("IVssContributionService").getData("ms.vss-tfs-web.page-data");r&&r.project&&(this._project=!0)}render(){const{isExpanded:e}=this.state;return this._providersAvailable?r.createElement("div",{className:l.css("flex","expandable-search-header"),ref:e=>this._searchHeader=e,onBlur:this._onBlur,"aria-owns":l.css(e&&"searchBox-dropDown")},e?r.createElement("label",{className:"search-context--label flex-self-center"},this._project?u.ProjectLabel:u.AccountLabel):null,r.createElement(v.SearchInputComponent,{executeSearch:this._onExecuteSearch,selectedProviderId:this.state.selectedProviderId,dropdownGapSize:0,helpClassName:l.css("expandable-header-search-help",this._isSearchSuggestionsEnabled&&"instant-search"),helpId:"searchBox-dropDown",showSearchProviders:!1,placeholderText:u.SearchPlaceholder,showSearchIcon:!0,spellCheck:!1,onInputFocus:this._expandSearchBox,componentRef:e=>{this._searchInputComponent=e}})):r.createElement("div",{className:"search-placeholder"})}componentDidMount(){super.componentDidMount(),this.addEventListener(document.body,"searchTabLoaded",this._onSearchTabLoaded),this.registerShortcut()}componentWillUnmount(){super.componentWillUnmount(),this._dispatchEvent("searchCollapsed")}componentDidUpdate(e,t){super.componentDidUpdate(e,t),!this.state.isExpanded&&this._searchInputComponent&&this._searchInputComponent.blur()}componentWillReceiveProps(e){super.componentWillReceiveProps(e);const t=this.context.pageContext.getService("IVssSearchService");this._providersAvailable=Object.keys(t.getProviders()).length>0}registerShortcut(){const e=this.context.pageContext.getService("IVssNavigationService").getDisplayedNavigation(),t=e.length>=3?e[2]:"";"ms.vss-search-platform.search-hidden-collection-hub-group"!==t&&"ms.vss-search-platform.search-hidden-project-hub-group"!==t&&this.context.pageContext.getService("IVssKeyboardShortcutService").registerShortcut(u.Global,{combos:["/","s"],description:u.SearchPlaceholder,action:()=>{this._searchInputComponent&&this._searchInputComponent.focus()}})}})}(),function(e){m=t.SearchHeaderSearchHeader={},Object.defineProperty(t,"__esModule",{value:!0});class s extends o.VssComponent{constructor(e,t){super(e,t),this.onExecuteSearch=(e=>{this.context.pageContext.getService("IVssSearchService").execute(e)});const s=t.pageContext.getService("IVssSearchService");this.providersAvailable=Object.keys(s.getProviders()).length>0}render(){return this.providersAvailable?r.createElement("div",{className:"flex search-header"},r.createElement(v.SearchInputComponent,{executeSearch:this.onExecuteSearch,dropdownGapSize:0,helpClassName:"header-search-help",showSearchProviders:!0,showSearchIcon:!0,spellCheck:!1})):r.createElement("div",{className:"search-placeholder"})}componentWillReceiveProps(e){const t=this.context.pageContext.getService("IVssSearchService");this.providersAvailable=Object.keys(t.getProviders()).length>0}}t.SearchHeaderSearchHeader.SearchHeaderInput=s,o.VssComponent.register("searchInput",s)}(),function(e){t[e]={},Object.defineProperty(t,"__esModule",{value:!0}),function(s){for(var r in s)t[e].hasOwnProperty(r)||(t[e][r]=s[r])}(m)}("SearchHeader"),function(e){S=t.SearchHelpSearchHelp={},Object.defineProperty(t,"__esModule",{value:!0});t.SearchHelpSearchHelp.SearchHelpComponent=class extends r.Component{constructor(){super(...arguments),this.onKeyDown=(e=>{if((38===e.which||40===e.which)&&null!==this.helpElement){const t=document.activeElement,s=this.helpElement.querySelectorAll("[tabIndex='-1']");let r=0;for(r=0;r<s.length&&t!==s[r];r++);r===s.length&&(r=-1),38===e.which?--r<0&&(r=s.length-1):++r===s.length&&(r=0),r>=0&&r<s.length&&s[r].focus(),e.preventDefault()}}),this.onMouseDown=(e=>{e.preventDefault()})}render(){return r.createElement("div",{ref:e=>{this.helpElement=e},className:"search-help",onKeyDown:this.onKeyDown,onMouseDown:this.onMouseDown},this.props.filterGroups.map((e,t)=>r.createElement(s,{key:t,filterGroup:e,searchInput:this.props.searchInput,filterText:this.props.filterText,onItemActivated:this.props.onItemActivated,onRenderFilterText:this.props.onRenderFilterText})),this.props.helpLink?r.createElement("div",null,r.createElement(p.FormatComponent,{format:u.SearchFindHelp},r.createElement("a",{className:"search-link",href:this.props.helpLink,tabIndex:-1,target:"vss-search-help"},u.SearchHelpPage))):null)}focus(){const e=null!==this.helpElement?this.helpElement.querySelector("[tabIndex='-1']"):null;e&&e.focus()}};class s extends r.Component{constructor(e){super(e),this.onKeyDown=(e=>{13===e.which&&this.toggleExpander()}),this.toggleExpander=(()=>{this.state.expanded?this.setState({expanded:!1,visibleCount:10}):this.setState({expanded:!0,visibleCount:Number.MAX_SAFE_INTEGER})}),this.state={expanded:!1,visibleCount:10}}render(){return r.createElement("div",null,r.createElement("div",null,this.props.filterGroup.caption?r.createElement("span",{className:"search-filter-caption"},this.props.filterGroup.caption):null,this.props.filterGroup.example?r.createElement("span",{className:"search-filter-example"},this.props.filterGroup.example):null),r.createElement("ul",{className:"search-filter-list "+(this.props.filterGroup.singleLine?"compact":"detailed")},this.props.filterGroup.filters.map((e,t)=>t>=this.state.visibleCount?null:r.createElement(n,{key:t,filter:e,searchInput:this.props.searchInput,filterText:this.props.filterText,onItemActivated:this.props.onItemActivated,onRenderFilterText:this.props.onRenderFilterText})),this.props.filterGroup.filters.length>=10?r.createElement("li",{className:"search-filter-item search-filter-expander",onClick:this.toggleExpander,onKeyDown:this.onKeyDown,tabIndex:-1},r.createElement(a.Icon,{className:"search-filter-expander-icon",iconName:this.state.expanded?"ChevronUpSmall":"ChevronDownSmall"}),r.createElement("span",null,this.state.expanded?u.SearchHelpLess:u.SearchHelpMore)):null,this.props.filterGroup.footer?r.createElement("li",{className:"search-filter-item search-filter-footer"},this.props.filterGroup.footer):null,0===this.props.filterGroup.filters.length?r.createElement("li",{className:"help-no-suggestion"},u.HelpNoSuggestions):null))}}class n extends r.Component{constructor(){super(...arguments),this.onActivate=(()=>{null!=this.listItem&&this.listItem.focus();const{filter:e,searchInput:t,onItemActivated:s}=this.props,r=this.props.searchInput.queryText(),n=e.shortcutText||e.text,i=e.getSuggestedText?e.getSuggestedText(r,n):n;e.replaceTextOnActivation?t.replaceText(i):t.appendText(i),s&&s(e)}),this.onKeyDown=(e=>{13===e.which&&this.onActivate()})}render(){const{onRenderFilterText:e,filter:t,filterText:s}=this.props;return r.createElement("li",{ref:e=>{this.listItem=e},className:"search-filter-item",onClick:this.onActivate,onKeyDown:this.onKeyDown,tabIndex:-1},r.createElement("div",{className:"search-filter-text"},e?e(t,s):t.text),this.props.filter.hint?r.createElement("div",{className:"search-filter-hint"},this.props.filter.hint):null)}}}(),function(e){t[e]={},Object.defineProperty(t,"__esModule",{value:!0}),function(s){for(var r in s)t[e].hasOwnProperty(r)||(t[e][r]=s[r])}(S)}("SearchHelp")},["Resources","Coordinator","SearchInput/SearchInput","SearchInput","ExpandableSearchBox/ExpandableSearchBox","SearchHeader/SearchHeader","SearchHeader","SearchHelp/SearchHelp","SearchHelp"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-features.search-content"}}));